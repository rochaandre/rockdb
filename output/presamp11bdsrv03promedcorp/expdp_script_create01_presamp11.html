<!- PRO --------------------------------------------------------------------------------------- PRO - PRO -- File name:   /Users/andre/Dropbox/scriptsGRAPHICO/report/output/presamp11bdsrv03promedcorp/expdp_script_create01_presamp11.html
- PRO -- Purpose:     script for expdp
- PRO -- Warning:
- PRO -- Author:      Andre Rocha
- PRO -- Version:     13/04/2021 10:50
- PRO -- Usage:
- PRO -- Example:
- PRO -- Notes:       Developed and tested on 11.2.0.3
- PRO -------------------------------------------------------------------------------------- PRO -- @report/sql/headerdoc.sql name.html "Created to output list of html report" "Pay attention to variables" "Usage" "example usage"
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- $Header:  $ -->
<!-- rock_copyright (c) 2021, All rights reserved. -->
<!-- Author: techmaxconsultoria@gmail.com -->
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="icon" href="icon/server.svg" type="image/x-icon" />
<title>script for expdp </title>
<style type="text/css">
body             {font:10pt Arial,Helvetica,Geneva,sans-serif; color:black; background:white;}
h1               {font-size:16pt; font-weight:bold; color:#336699; border-bottom:5px solid #336699; margin-top:0pt; margin-bottom:0pt; padding:0px 0px 0px 0px;}
h2               {font-size:14pt; font-weight:bold; color:#336699; margin-top:4pt; margin-bottom:0pt;}
h3               {font-size:12pt; font-weight:bold; color:#336699; margin-top:4pt; margin-bottom:0pt;}
pre              {font:8pt monospace,Monaco,"Courier New",Courier;}
a                {color:#663300;}
table            {font-size:8pt; border-collapse:collapse; empty-cells:show; white-space:nowrap; border:1px solid #336699;}
li               {font-size:8pt; color:black; padding-left:4px; padding-right:4px; padding-bottom:2px;}
th               {font-weight:bold; color:red; background:#0066CC; padding-left:4px; padding-right:4px; padding-bottom:2px;}
tr               {color:black; background:white;}
tr:hover         {color:white; background:#0066CC;}
tr.main          {color:black; background:white;}
tr.main:hover    {color:black; background:white;}
td               {vertical-align:top; border:1px solid #336699;}
td.c             {text-align:center;}
font.n           {font-size:8pt; font-style:italic; color:#336699;}
font.f           {font-size:8pt; color:#999999; border-top:1px solid #336699; margin-top:30pt;}
div.google-chart {width:809px; height:500px;}
</style>
</head>

<h1> <a href="index_presamp11.html" target="_blank"><img src="icon/server.svg" alt="index_presamp11.html" height="33" width="52" /></a> presamp11.html <em>(script for expdp )</em>  </h1>
<PRE>

+------------------------------------------------------------------------------+
|     Best pratices to avoid issues and get better performance                 |
+------------------------------------------------------------------------------+

purge dba_recycle bin


remove stats from sysaux

@?/rdbms/admin/awrinfo.sql
begin
for i in reverse 31..100
loop
dbms_stats.purge_stats(sysdate-i)
end loop
end
+------------------------------------------------------------------------------+
|     Configure job_queue_processes                                            |
+------------------------------------------------------------------------------+

alter system set job_queue_processes=0

+------------------------------------------------------------------------------+
|     Increase SGA and PGA                                                     |
+------------------------------------------------------------------------------+

alter system set pga_aggregate_target=50G scope=both

+------------------------------------------------------------------------------+
|     Stop JOBs                                                                |
+------------------------------------------------------------------------------+
alter system set job_queue_processes=0 scope=both


+------------------------------------------------------------------------------+
|     Check LOB - parallel not work for LOB                                    |
+------------------------------------------------------------------------------+
Try to separate non blob from blob data - identify the LOB tables

select segment_name, bytes, owner,
(select table_name from dba_lobs a where d.segment_name = a.segment_name) as tablename, d.tablespace_name
from dba_segments d
where segment_type = 'LOBSEGMENT'
order by bytes desc

SELECT  s.tablespace_name ,l.owner,l.table_name,l.column_name,l.segment_name,s.segment_type, round(s.bytes/1024/1024/1024,2) "Size(GB)"
FROM DBA_SEGMENTS s,dba_lobs l
where l.owner = s.owner and l.segment_name = s.segment_name
and l.owner not in ('SYS','SYSTEM','APPS','APPLSYS')
--and round(s.bytes/1024/1024/1024,2)>1
order by s.bytes desc
+------------------------------------------------------------------------------+
|     Purge logs                                                               |
+------------------------------------------------------------------------------+

select *
from   (select substr (owner, 1, 10) owner,
substr (segment_name, 1, 30) seg_name,
substr (segment_type, 1, 10) type,
bytes,
extents,
rank() over (order by bytes desc) position
from   dba_segments
where  tablespace_name = 'SYSAUX'
order  by bytes, extents desc)
where   position < 10
order   by position
/
EXECUTE DBMS_SCHEDULER.auto_purge
alter table SCHEDULER$_EVENT_LOG shrink space CASCADE
execute DBMS_SCHEDULER.PURGE_LOG()

+------------------------------------------------------------------------------+
|     Increase PGA                                                             |
+------------------------------------------------------------------------------+
alter system set pga_aggregate_target=50G scope=both

+------------------------------------------------------------------------------+
|     expdp slow                                                               |
+------------------------------------------------------------------------------+
DataPump Export Is Slow And Appears To Hang (Doc ID 790168.1)

TRANSFORM=DISABLE_ARCHIVE_LOGGING:Y
sort_write_buffers=6,sort_write_buffer_size=64000,sort_direct_write=true, andsort_area_size
parallel_execution_message_size=32768
dbms_scheduler.disable('BSLN_MAINTAIN_STATS_JOB')
EXEC DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(INTERVAL=>0)
EXEC DBMS_AUTO_TASK_ADMIN.DISABLE
After importing re-enable:EXEC DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(INTERVAL=>15)
EXEC DBMS_AUTO_TASK_ADMIN.ENABLE


After further tests I concluded that the following changes helped with export data pump:
parallel=32, compared to 8, reduced unload times from approximately 40 minutes to 12 minutes
parallel_execution_message_size (data pump workers are fed by PX slaves) was the default of 2152 bytes and increasing it to 16384 reduced the unload by another approximately 5% percent


+------------------------------------------------------------------------------+
|   Export without rows and no default schemas/users.
+------------------------------------------------------------------------------+

expdp parfile=expdp_par01.par

expdp USERID=dbajobs/dbajobs@192.168.1.180:1521/presamp JOB_NAME=exp_02NOROWSC DUMPFILE=exp_02NOROWSC$varYYYYMMDD%U.dmp LOG=:exp_02NOROWSC20210413log DIRECTORY= FULL=Y rows=n consistent=y

expdp USERID=dbajobs/dbajobs@192.168.1.180:1521/presamp JOB_NAME=exp_03FULLROWS DUMPFILE=exp_03FULLROWS$varYYYYMMDD%U.dmp LOG=:exp_03FULLROWS20210413log DIRECTORY= FULL=Y rows=y consistent=y

+------------------------------------------------------------------------------+
|    Export with rows and no default schemas/users.
+------------------------------------------------------------------------------+

expdp parfile=expdp_par04.par

+------------------------------------------------------------------------------+
|    Export with rows and all schemas/users.
+------------------------------------------------------------------------------+

expdp parfile=expdp_par05.par
